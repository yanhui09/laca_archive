---
title: "In silico test"
author:
  - name: Yan Hui
    affiliation: Department of Food Science, University of Copenhagen
    email: huiyan@food.ku.dk
date: 09/17/2023
output:
  html_document:
    toc: true
link-citations: yes
bibliography: ref.bib
csl: cell.csl
---

```{r, meshclust_threshold}
# recall, percentage of reads correctly being grouped into one cluster
# loss, percentage of reads not being grouped into any cluster
library(data.table)
library(tidyverse)
# fqs_header: TP
fs <- list.files(
  path = "./data/simulate/clust/fqs_header",
  pattern = "*[0-9].txt", full.names = TRUE, recursive = TRUE)
dt <- rbindlist(sapply(fs, function(x) fread(x, header=FALSE, sep=""), simplify = FALSE), idcol = "file", use.names = FALSE) #nolint
dt$benchmark <- gsub("^.*fqs_header/(nanopore2020|nanopore2023|nanopore2023duplex|pacbio2016ccs)_(even10|skew10)_si.*.txt", "\\1", dt$file) #nolint
dt$profile <- gsub("^.*fqs_header/(nanopore2020|nanopore2023|nanopore2023duplex|pacbio2016ccs)_(even10|skew10)_si.*.txt", "\\2", dt$file) #nolint
dt$id <- as.numeric(gsub("^.*fqs_header/.*_si(9095|9597|9798|9899|99100)([0-9]+).txt", "\\1", dt$file)) #nolint
dt$depth <- as.numeric(gsub("^.*fqs_header/.*_si(9095|9597|9798|9899|99100)([0-9]+).txt", "\\2", dt$file)) #nolint
dt <- dt[, !"file"]
# everthing before the first whitespace
dt$seqid <- sub(" .*$", "", dt$V1)
dt$seqid <- sub("^@", "", dt$seqid)
dt$len <- as.numeric(gsub("^.*\ length=([0-9]+)\ .*", "\\1", dt$V1))
dt$eflen <- as.numeric(gsub("^.*error-free_length=([0-9]+).*", "\\1", dt$V1))
dt$id2ref <- as.numeric(gsub("^.*read_identity=(.*)%", "\\1", dt$V1))

# separate V2 by ',' into multiple columns
dt$V2 <- gsub("[^ ]+ (.*) length=.*", "\\1", dt$V1)
# adapter has no direction
dt <- dt[, c("V3", "V4", "V5", "V6", "V7") := tstrsplit(V2, " ", fixed = TRUE)] #nolint
dt <- dt[, c("ref", "strand", "pos") := tstrsplit(V3, ",", fixed = TRUE)] #nolint
dt$type <- dt$ref
dt$type[dt$V4 == "chimera"] <- "chimera"
# ref_[0-9]+ -> ref_seq
dt$type <- gsub("^ref_[0-9]+", "ref_seq", dt$type)
dt <- dt[, !c("V1", "V3", "V4", "V5", "V6", "V7")]
df_ref <- as.data.frame(dt)
colnames(df_ref) <- c("benchmark", "profile", "id", "depth", "seqid", "len", "eflen", "id2ref", "info", "ref", "strand", "pos", "type") #nolint

# cluster: P
fs <- list.files(
  path = "./data/simulate/clust",
  pattern = "*.tsv", full.names = TRUE, recursive = TRUE)
# grep meshclust_..
fs <- grep(pattern = '.*/meshclust_.*', fs, value = TRUE)
dt <- rbindlist(sapply(fs, function(x) fread(x, header=FALSE, sep="\t", blank.lines.skip = TRUE), simplify = FALSE), idcol = "file", use.names = FALSE) #nolint
dt$benchmark <- gsub("^.*(nanopore2020|nanopore2023|nanopore2023duplex|pacbio2016ccs)/(even10|skew10)/.*", "\\1", dt$file) #nolint
dt$profile <- gsub("^.*(nanopore2020|nanopore2023|nanopore2023duplex|pacbio2016ccs)/(even10|skew10)/.*", "\\2", dt$file) #nolint
dt$meshclust <- gsub("^.*(nanopore2020|nanopore2023|nanopore2023duplex|pacbio2016ccs)/(even10|skew10)/.*meshclust_(auto|75|80|85|90|95)/.*", "\\3", dt$file) #nolint
dt$id <- as.numeric(gsub("^.*/si(9095|9597|9798|9899|99100).*", "\\1", dt$file)) #nolint
dt$depth <- as.numeric(
  gsub("^.*/si(9095|9597|9798|9899|99100)([0-9]+).*", "\\2", dt$file)) #nolint
# rm ">" in V2
dt$V2 <- gsub("^>", "", dt$V2)
dt <- dt[, !"file"]
df_cls <- as.data.frame(dt)
colnames(df_cls) <- c("cluster", "seqid", "est_id", "member", "benchmark", "profile", "meshclust", "id", "depth") #nolint
df_merge <- df_cls %>%
  full_join(df_ref, by = c("seqid", "benchmark", "profile", "id", "depth")) %>%
  group_by(benchmark, profile, meshclust, id, depth, cluster) %>%
  # number of reads supporting the cluster
  mutate(snreads = length(unique(seqid))) %>%
  ungroup() %>%
  # number of reads supporting the class
  group_by(benchmark, profile, meshclust, id, depth, cluster, ref) %>%
  mutate(snreads2 = length(unique(seqid))) %>%
  # sort by nsreads, the most common class comes first
  arrange(desc(snreads2), ref, .by_group = TRUE) %>%
  ungroup()

# rename nanopore2023duplex to nanopore duplex
df_merge$benchmark[df_merge$benchmark == "nanopore2023duplex"] <- "nanopore2023dup"

# snreads >= 10
df_merge <- df_merge %>%
  filter(snreads >= 10)

#https://stackoverflow.com/questions/9253843/r-clustering-purity-metric
purity <- function(clusters, classes) {
  sum(apply(table(classes, clusters), 2, max)) / length(clusters)
}
library(aricode)

df_comp0 <- df_merge %>%
  filter(! is.na(cluster)) %>%
  group_by(benchmark, profile, meshclust, id, depth, cluster, snreads) %>%
  summarize(
    Purity = purity(as.integer(as.ordered(cluster)), as.integer(as.ordered(ref))), #nolint
  ) %>%
  ungroup() %>%
  gather(key, value, -benchmark, -profile, -meshclust, -id, -depth, -cluster, -snreads) #nolint
library(ggprism)
library(RColorBrewer)
p0_cls <- df_comp0 %>%
  filter(id %in% c(9095,9597,9798,9899,99100)) %>%
  ggplot( 
    aes(
      x = snreads,
      y = value, 
      color = factor(
        meshclust,
        levels = c("auto", "75", "80", "85", "90", "95") #nolint
        ),
      shape = factor(
        profile,
        levels = c("even10", "skew10")
        ))) +  
  geom_point() +
  labs(
    x = "# of supporrting reads",
    y = "Purity",
    color = "Meshclust threshold",
    shape = "Profile"
   ) +
  scale_color_manual(values = brewer.pal(8, "Spectral")[c(1,2,3,5,7,8)]) +
  facet_grid(
    benchmark ~ factor(
      id, 
      levels = c(9095,9597,9798,9899,99100),
      labels = c("5~10%", "3~5%", "2~3%", "1~2%", "0~1%") #nolint
      ), scales = "free") +
  theme_prism() +
  theme(
    legend.title = element_text(),
    axis.text.x.bottom = element_text(
      angle = 90, vjust = 0.5, hjust = 1, size = 9
      )
    )
#p0_cls

df_comp <- df_merge %>%
  filter(! is.na(cluster)) %>%
  group_by(benchmark, profile, meshclust, id, depth) %>%
  summarise(
    Size = length(unique(cluster)),
    Purity = purity(as.integer(as.ordered(cluster)), as.integer(as.ordered(ref))), #nolint
    NMI = NMI(as.integer(as.ordered(ref)), as.integer(as.ordered(cluster))),
  ) %>%
  gather(key, value, -benchmark, -profile, -meshclust, -id, -depth) #nolint


p1_cls <- df_comp %>%
  filter(id %in% c(9095,9597,9798,9899,99100)) %>% 
  ggplot( 
    aes(
      x = meshclust,
      y = value, 
      color = factor(
        id, 
        levels = c(9095,9597,9798,9899,99100),
        labels = c("5~10%", "3~5%", "2~3%", "1~2%", "0~1%")), #nolint
      fill = factor(
        id, 
        levels = c(9095,9597,9798,9899,99100),
        labels = c("5~10%", "3~5%", "2~3%", "1~2%", "0~1%") #nolint
        ))) +
  geom_bar(position="dodge", stat="identity") +
  labs(
    x = "Meshclust threshold",
    y = "Quality of clustering",
    color = "% of Divergence",
    fill = "% of Divergence"
   ) +
  scale_color_manual(values = brewer.pal(8, "Spectral")[c(1,3,4,7,8)]) +
  scale_fill_manual(values = brewer.pal(8, "Spectral")[c(1,3,4,7,8)]) +
  facet_grid(
    factor(
      key,
      levels = c("Size", "Purity", "NMI")) ~ benchmark + factor(
      profile,
      levels = c("even10", "skew10")), #nolint
    scales = "free", space = "free_x") +
  theme_prism() +
  theme(
    legend.title = element_text(),
    axis.text.x.bottom = element_text(
      angle = 90, vjust = 0.5, hjust = 1, size = 9
      )
    )
#p1_cls
# pct of clustered reads
df_clust <- df_merge %>%
  group_by(benchmark, profile, id, depth) %>%
  mutate(nreads = length(unique(seqid))) %>%
  filter(!is.na(cluster)) %>%
  group_by(benchmark, profile, meshclust, id, depth, type) %>%
  reframe(pct = length(unique(seqid))/nreads * 100)  %>%
  # rm duplicate lines
  distinct()

p1_clust <- df_clust %>%
  filter(id %in% c(9095,9597,9798,9899,99100)) %>% 
  ggplot( 
    aes(
      x = meshclust,
      y = pct, 
        )) +
  geom_bar(stat = "identity", aes(fill = type)) +
  labs(
    x = "Meshclust threshold",
    y = "% of clustered reads",
    fill = "Type"
   ) +
  scale_fill_manual(values = brewer.pal(4, "Spectral")[c(1,4)]) +
  facet_grid(
    factor(
      id, 
      levels = c(9095,9597,9798,9899,99100),
      labels = c("5~10%", "3~5%", "2~3%", "1~2%", "0~1%") #nolint
      ) ~ benchmark + profile,
      scales = "free_x", space = "free_x") +
  theme_prism() +
  theme(
    legend.title = element_text(),
    # axis font angle
    axis.text.x.bottom = element_text(
      angle = 90, vjust = 0.5, hjust = 1, size = 9
      ))
#p1_clust
p1_clustid <- df_merge %>%
  filter(!is.na(cluster)) %>%
  filter(id %in% c(9095,9597,9798,9899,99100)) %>% 
  ggplot( 
    aes(
      x = meshclust,
      y = id2ref, 
        )) +
  geom_boxplot(
    aes(fill=type),
    position = position_dodge(preserve = "single")
    ) +
  labs(
    x = "Meshclust threshold",
    y = "% of identity relative to reference",
    fill = "Type"
   ) +
  scale_fill_manual(values = brewer.pal(4, "Spectral")[c(1,4)]) +
  facet_grid(
    factor(
      id, 
      levels = c(9095,9597,9798,9899,99100),
      labels = c("5~10%", "3~5%", "2~3%", "1~2%", "0~1%") #nolint
      ) ~ benchmark + profile,
      scales = "free_x", space = "free_x") +
  theme_prism() +
  theme(
    legend.title = element_text(),
    # axis font angle
    axis.text.x.bottom = element_text(
      angle = 90, vjust = 0.5, hjust = 1, size = 9
      ))
#p1_clustid

dir.create("./figure/simulate/meshclust_threshold", recursive = TRUE, showWarnings = FALSE) #nolint
ggsave("./figure/simulate/meshclust_threshold/p0_cls_point.png", p0_cls, width = 12, height = 10) #nolint
ggsave("./figure/simulate/meshclust_threshold/p1_cls_bar.png", p1_cls, width = 18, height = 8) #nolint
ggsave("./figure/simulate/meshclust_threshold/p1_clust_pct.png", p1_clust, width = 18, height = 12) #nolint
ggsave("./figure/simulate/meshclust_threshold/p1_clustid_identity.png", p1_clustid, width = 18, height = 12) #nolint
```

```{r, clust_mode}
# recall, percentage of reads correctly being grouped into one cluster
# loss, percentage of reads not being grouped into any cluster
library(data.table)
library(tidyverse)
# fqs_header: TP
fs <- list.files(
  path = "./data/simulate/clust/fqs_header",
  pattern = "*[0-9].txt", full.names = TRUE, recursive = TRUE)
dt <- rbindlist(sapply(fs, function(x) fread(x, header=FALSE, sep=""), simplify = FALSE), idcol = "file", use.names = FALSE) #nolint
dt$benchmark <- gsub("^.*fqs_header/(nanopore2020|nanopore2023|nanopore2023duplex|pacbio2016ccs)_(even10|skew10)_si.*.txt", "\\1", dt$file) #nolint
dt$profile <- gsub("^.*fqs_header/(nanopore2020|nanopore2023|nanopore2023duplex|pacbio2016ccs)_(even10|skew10)_si.*.txt", "\\2", dt$file) #nolint
dt$id <- as.numeric(gsub("^.*fqs_header/.*_si(9095|9597|9798|9899|99100)([0-9]+).txt", "\\1", dt$file)) #nolint
dt$depth <- as.numeric(gsub("^.*fqs_header/.*_si(9095|9597|9798|9899|99100)([0-9]+).txt", "\\2", dt$file)) #nolint
dt <- dt[, !"file"]
# everthing before the first whitespace
dt$seqid <- sub(" .*$", "", dt$V1)
dt$seqid <- sub("^@", "", dt$seqid)
dt$len <- as.numeric(gsub("^.*\ length=([0-9]+)\ .*", "\\1", dt$V1))
dt$eflen <- as.numeric(gsub("^.*error-free_length=([0-9]+).*", "\\1", dt$V1))
dt$id2ref <- as.numeric(gsub("^.*read_identity=(.*)%", "\\1", dt$V1))

# separate V2 by ',' into multiple columns
dt$V2 <- gsub("[^ ]+ (.*) length=.*", "\\1", dt$V1)
# adapter has no direction
dt <- dt[, c("V3", "V4", "V5", "V6", "V7") := tstrsplit(V2, " ", fixed = TRUE)] #nolint
dt <- dt[, c("ref", "strand", "pos") := tstrsplit(V3, ",", fixed = TRUE)] #nolint
dt$type <- dt$ref
dt$type[dt$V4 == "chimera"] <- "chimera"
# ref_[0-9]+ -> ref_seq
dt$type <- gsub("^ref_[0-9]+", "ref_seq", dt$type)
dt <- dt[, !c("V1", "V3", "V4", "V5", "V6", "V7")]
df_ref <- as.data.frame(dt)
colnames(df_ref) <- c("benchmark", "profile", "id", "depth", "seqid", "len", "eflen", "id2ref", "info", "ref", "strand", "pos", "type") #nolint

# cluster: P
fs <- list.files(
  path = "./data/simulate/clust",
  pattern = "*.tsv", full.names = TRUE, recursive = TRUE)
# grep meshclust_..
fs1 <- grep(pattern = '.*(nanopore2020|nanopore2023)/.*meshclust_auto/meshclust/si.*', fs, value = TRUE) #nolint
fs2 <- grep(pattern = '.*(nanopore2023duplex|pacbio2016ccs)/.*meshclust_95/meshclust/si.*', fs, value = TRUE) #nolint
fs <- c(fs1, fs2)
dt <- rbindlist(sapply(fs, function(x) fread(x, header=FALSE, sep="\t", blank.lines.skip = TRUE), simplify = FALSE), idcol = "file", use.names = FALSE) #nolint
dt$benchmark <- gsub("^.*(nanopore2020|nanopore2023|nanopore2023duplex|pacbio2016ccs)/(even10|skew10)/.*", "\\1", dt$file) #nolint
dt$profile <- gsub("^.*(nanopore2020|nanopore2023|nanopore2023duplex|pacbio2016ccs)/(even10|skew10)/.*", "\\2", dt$file) #nolint
dt$clust <- gsub("^.*(nanopore2020|nanopore2023|nanopore2023duplex|pacbio2016ccs)/(even10|skew10)/clust_compare/(.*)_(auto|95)/.*", "\\3", dt$file) #nolint
dt$meshclust <- gsub("^.*(nanopore2020|nanopore2023|nanopore2023duplex|pacbio2016ccs)/(even10|skew10)/clust_compare/(.*)_(auto|95)/.*", "\\4", dt$file) #nolint
dt$id <- as.numeric(gsub("^.*/si(9095|9597|9798|9899|99100).*", "\\1", dt$file)) #nolint
dt$depth <- as.numeric(
  gsub("^.*/si(9095|9597|9798|9899|99100)([0-9]+).*", "\\2", dt$file)) #nolint
dt$base <- gsub("^.*/meshclust/(si.*).tsv", "\\1", dt$file) #nolint
cluster <- mapply(dt$base, dt$V1, FUN = function(x, y) paste0(x, "_", y)) #nolint
dt$V1 <- cluster
# rm ">" in V2
dt$V2 <- gsub("^>", "", dt$V2)
dt <- dt[, !c("file", "base")]
df_cls1 <- as.data.frame(dt)
colnames(df_cls1) <- c("cluster", "seqid", "est_id", "member", "benchmark", "profile", "clust", "meshclust", "id", "depth") #nolint

# pre-cluster: isONclust, umapcust, isONclust+umapclust
fs <- list.files(
  path = "./data/simulate/clust",
  pattern = "*.csv", full.names = TRUE, recursive = TRUE)
# grep read2cluster 
fs1 <- grep(pattern = '.*/isONclust_meshclust_.*/isONclust/read2cluster/si.*', fs, value = TRUE) #nolint
fs2 <- grep(pattern = '.*/umapclust_meshclust_.*/umapclust/read2cluster/si.*', fs, value = TRUE) #nolint
fs3 <- grep(pattern = '.*/isONclust_umapclust_meshclust_.*/umapclust/read2cluster/si.*', fs, value = TRUE) #nolint
fs <- c(fs1, fs2, fs3)
dt <- rbindlist(sapply(fs, function(x) fread(x, header=FALSE, sep="\t", blank.lines.skip = TRUE), simplify = FALSE), idcol = "file", use.names = FALSE) #nolint
dt$benchmark <- gsub("^.*(nanopore2020|nanopore2023|nanopore2023duplex|pacbio2016ccs)/(even10|skew10)/.*", "\\1", dt$file) #nolint
dt$profile <- gsub("^.*(nanopore2020|nanopore2023|nanopore2023duplex|pacbio2016ccs)/(even10|skew10)/.*", "\\2", dt$file) #nolint
dt$clust <- gsub("^.*(nanopore2020|nanopore2023|nanopore2023duplex|pacbio2016ccs)/(even10|skew10)/clust_compare/(.*)_(auto|95)/(.*)/read2cluster/.*", "\\5", dt$file) #nolint
# isONclust+umapclust
index <- grep(".*/isONclust_umapclust_meshclust_(auto|95)/umapclust/read2cluster/", dt$file) #nolint
dt$clust[index] <- "isONclust+umapclust"

dt$meshclust <- gsub("^.*(nanopore2020|nanopore2023|nanopore2023duplex|pacbio2016ccs)/(even10|skew10)/clust_compare/(.*)_(auto|75|80|85|90|95)/.*", "\\4", dt$file) #nolint
dt$id <- as.numeric(gsub("^.*/si(9095|9597|9798|9899|99100).*", "\\1", dt$file)) #nolint
dt$depth <- as.numeric(
  gsub("^.*/si(9095|9597|9798|9899|99100)([0-9]+).*", "\\2", dt$file)) #nolint
dt$base <- gsub("^.*/read2cluster/(si.*).csv", "\\1", dt$file) #nolint
dt <- dt[, !c("file")]
dt$est_id <- NA
dt$member <- NA
dt <- dt[ ,c("base", "V1", "est_id", "member", "benchmark", "profile", "clust", "meshclust", "id", "depth")] #nolint
df_cls2 <- as.data.frame(dt)
colnames(df_cls2) <- c("cluster", "seqid", "est_id", "member", "benchmark", "profile", "clust", "meshclust", "id", "depth") #nolint

# combine df_cls1, df_cls2
df_cls <- rbind.data.frame(df_cls1, df_cls2)
df_merge <- df_cls %>%
  full_join(df_ref, by = c("seqid", "benchmark", "profile", "id", "depth")) %>%
  group_by(benchmark, profile, meshclust, id, depth, cluster) %>%
  # number of reads supporting the cluster
  mutate(snreads = length(unique(seqid))) %>%
  ungroup() %>%
  # number of reads supporting the class
  group_by(benchmark, profile, meshclust, id, depth, cluster, ref) %>%
  mutate(snreads2 = length(unique(seqid))) %>%
  # sort by nsreads, the most common class comes first
  arrange(desc(snreads2), ref, .by_group = TRUE) %>%
  ungroup()

# rename nanopore2023duplex to nanopore2023dup
df_merge$benchmark[df_merge$benchmark == "nanopore2023duplex"] <- "nanopore2023dup"
#########################
# snreads >= 10
df_merge <- df_merge %>%
  filter(snreads >= 10)

#https://stackoverflow.com/questions/9253843/r-clustering-purity-metric
purity <- function(clusters, classes) {
  sum(apply(table(classes, clusters), 2, max)) / length(clusters)
}
library(aricode)

df_comp0 <- df_merge %>%
  filter(! is.na(cluster)) %>%
  group_by(benchmark, profile, clust, meshclust, id, depth, cluster, snreads) %>% #nolint
  summarize(
    Purity = purity(as.integer(as.ordered(cluster)), as.integer(as.ordered(ref))), #nolint
  ) %>%
  ungroup() %>%
  gather(key, value, -benchmark, -profile, -clust, -meshclust, -id, -depth, -cluster, -snreads) #nolint
library(ggprism)
library(RColorBrewer)
p0_cls <- df_comp0 %>%
  filter(id %in% c(9095,9597,9798,9899,99100)) %>%
  ggplot( 
    aes(
      x = snreads,
      y = value, 
      color = factor(
        clust,
        levels = c("isONclust", "isONclust_meshclust", "umapclust", "umapclust_meshclust", "isONclust+umapclust", "isONclust_umapclust_meshclust", "meshclust"), #nolint
        labels = c("isONclust","isONclust+", "umapclust", "umapclust+", "isONclust+umapclust", "isONclust+umapclust+", "meshclust"), #nolint
        ),
      shape = factor(
        profile,
        levels = c("even10", "skew10")
        ))) +  
  geom_point() +
  labs(
    x = "# of supporrting reads",
    y = "Purity",
    color = "Cluster mode",
    shape = "Profile"
   ) +
  scale_color_manual(values = brewer.pal(8, "Spectral")[c(1,2,3,4,6,7,8)]) +
  facet_grid(
    benchmark ~ factor(
      id, 
      levels = c(9095,9597,9798,9899,99100),
      labels = c("5~10%", "3~5%", "2~3%", "1~2%", "0~1%") #nolint
      ), scales = "free") +
  theme_prism() +
  theme(
    legend.title = element_text(),
    axis.text.x.bottom = element_text(
      angle = 90, vjust = 0.5, hjust = 1, size = 9
      )
    )
#p0_cls
df_comp <- df_merge %>%
  filter(! is.na(cluster)) %>%
  group_by(benchmark, profile, clust, meshclust, id, depth) %>%
  summarise(
    Size = length(unique(cluster)),
    Purity = purity(as.integer(as.ordered(cluster)), as.integer(as.ordered(ref))), #nolint
    NMI = NMI(as.integer(as.ordered(ref)), as.integer(as.ordered(cluster))),
  ) %>%
  gather(key, value, -benchmark, -profile, -clust, -meshclust, -id, -depth) #nolint


p1_cls <- df_comp %>%
  filter(id %in% c(9095,9597,9798,9899,99100)) %>% 
  ggplot( 
    aes(
      x = factor(
        clust,
        levels = c("isONclust", "isONclust_meshclust", "umapclust", "umapclust_meshclust", "isONclust+umapclust", "isONclust_umapclust_meshclust", "meshclust"), #nolint
        labels = c("isONclust","isONclust+", "umapclust", "umapclust+", "isONclust+umapclust", "isONclust+umapclust+", "meshclust"), #nolint
        ),
      y = value, 
      color = factor(
        id, 
        levels = c(9095,9597,9798,9899,99100),
        labels = c("5~10%", "3~5%", "2~3%", "1~2%", "0~1%")), #nolint
      fill = factor(
        id, 
        levels = c(9095,9597,9798,9899,99100),
        labels = c("5~10%", "3~5%", "2~3%", "1~2%", "0~1%") #nolint
        ))) +
  geom_bar(position="dodge", stat="identity") +
  labs(
    x = "",
    y = "Quality of clustering",
    color = "% of Divergence",
    fill = "% of Divergence"
   ) +
  scale_color_manual(values = brewer.pal(8, "Spectral")[c(1,3,4,7,8)]) +
  scale_fill_manual(values = brewer.pal(8, "Spectral")[c(1,3,4,7,8)]) +
  facet_grid(
    factor(
      key,
      levels = c("Size", "Purity", "NMI")) ~ benchmark + factor(
      profile,
      levels = c("even10", "skew10")), #nolint
    scales = "free", space = "free_x") +
  theme_prism() +
  theme(
    legend.title = element_text(),
    axis.text.x.bottom = element_text(
      angle = 90, vjust = 0.5, hjust = 1, size = 9
      ))
#p1_cls
# pct of clustered reads
df_clust <- df_merge %>%
  group_by(benchmark, profile, id, depth) %>%
  mutate(nreads = length(unique(seqid))) %>%
  filter(!is.na(cluster)) %>%
  group_by(benchmark, profile, clust, meshclust, id, depth, type) %>%
  reframe(pct = length(unique(seqid))/nreads * 100)  %>%
  # rm duplicate lines
  distinct()

p1_clust <- df_clust %>%
  filter(id %in% c(9095,9597,9798,9899,99100)) %>% 
  ggplot( 
    aes(
      x = factor(
        clust,
        levels = c("isONclust", "isONclust_meshclust", "umapclust", "umapclust_meshclust", "isONclust+umapclust", "isONclust_umapclust_meshclust", "meshclust"), #nolint
        labels = c("isONclust","isONclust+", "umapclust", "umapclust+", "isONclust+umapclust", "isONclust+umapclust+", "meshclust"), #nolint
        ),
      y = pct, 
        )) +
  geom_bar(stat = "identity", aes(fill = type)) +
  labs(
    x = "",
    y = "% of clustered reads",
    fill = "Type"
   ) +
  scale_fill_manual(values = brewer.pal(4, "Spectral")[c(1,4)]) +
  facet_grid(
    factor(
      id, 
      levels = c(9095,9597,9798,9899,99100),
      labels = c("5~10%", "3~5%", "2~3%", "1~2%", "0~1%") #nolint
      ) ~ benchmark + profile,
      scales = "free_x", space = "free_x") +
  theme_prism() +
  theme(
    legend.title = element_text(),
    # axis font angle
    axis.text.x.bottom = element_text(
      angle = 90, vjust = 0.5, hjust = 1, size = 9
    )) 
#p1_clust
p1_clustid <- df_merge %>%
  filter(!is.na(cluster)) %>%
  filter(id %in% c(9095,9597,9798,9899,99100)) %>% 
  ggplot( 
    aes(
      x = factor(
        clust,
        levels = c("isONclust", "isONclust_meshclust", "umapclust", "umapclust_meshclust", "isONclust+umapclust", "isONclust_umapclust_meshclust", "meshclust"), #nolint
        labels = c("isONclust","isONclust+", "umapclust", "umapclust+", "isONclust+umapclust", "isONclust+umapclust+", "meshclust"), #nolint
        ),
      y = id2ref, 
        )) +
  geom_boxplot(
    aes(fill=type),
    position = position_dodge(preserve = "single")
    ) +
  labs(
    x = "",
    y = "% of identity relative to reference",
    fill = "Type"
   ) +
  scale_fill_manual(values = brewer.pal(4, "Spectral")[c(1,4)]) +
  facet_grid(
    factor(
      id, 
      levels = c(9095,9597,9798,9899,99100),
      labels = c("5~10%", "3~5%", "2~3%", "1~2%", "0~1%") #nolint
      ) ~ benchmark + profile,
      scales = "free_x", space = "free_x") +
  theme_prism() +
  theme(
    legend.title = element_text(),
    # axis font angle
    axis.text.x.bottom = element_text(
      angle = 90, vjust = 0.5, hjust = 1, size = 9
    )) 
#p1_clustid
dir.create("./figure/simulate/clust_mode", recursive = TRUE, showWarnings = FALSE)
ggsave("./figure/simulate/clust_mode/p0_cls_point.png", p0_cls, width = 12, height = 10) #nolint
ggsave("./figure/simulate/clust_mode/p1_cls_bar.png", p1_cls, width = 18, height = 8) #nolint
ggsave("./figure/simulate/clust_mode/p1_clust_pct.png", p1_clust, width = 18, height = 12) #nolint
ggsave("./figure/simulate/clust_mode/p1_clustid_identity.png", p1_clustid, width = 18, height = 12) #nolint
```


```{r, clean}
library(data.table)
library(tidyverse)
fs_all <- list.files(
  path = "./data/simulate",
  pattern = "*.paf", full.names = TRUE, recursive = TRUE)
fs <- grep(pattern = '.*/cut/.*.paf', fs_all, value = TRUE)

dt <- rbindlist(sapply(fs, function(x) fread(x, header=FALSE), simplify = FALSE), idcol = "file", use.names = FALSE) #nolint
dt$benchmark <- gsub("^.*simulate/(even10|skew10)/RepAlignRef.*", "\\1", dt$file) #nolint
# extract benchmark info from file name
dt$bin <- gsub("^.*RepAlignRef/(bin|nobin).*", "\\1", dt$file)
dt$id <- as.numeric(
  gsub("^.*/si(8090|90100|9095|95100|9597|97100|9799|9798|98100|9899|99100).*", "\\1", dt$file)) #nolint
dt$reads0 <- as.numeric(
  gsub("^.*/si(8090|90100|9095|95100|9597|97100|9799|9798|98100|9899|99100)([0-9]+).*", #nolint
  "\\2", dt$file))
dt$alignment <- gsub("^.*/si[0-9]+_(asm[0-9]+).*", "\\1", dt$file)
dt$cluster <- gsub("^.*repseqs_refalign/(.*)/cut/.*", "\\1", dt$file)
dt$seqs <- "all"
#dt$seqs <- gsub("^.*nanosim20(bin|nobin)_(all|i099c050).*", "\\2", dt$file)
dt <- dt[, !"file"]
df <- as.data.frame(dt)
# https://github.com/lh3/miniasm/blob/master/PAF.md
colnames(df) <- c("qseq", "qlen", "qstart", "qend", "strand",
 "tseq", "tlen", "tstart", "tend", "matches", "alnlen", "mapq",
  "benchmark", "bin", "id", "depth", "asm", "consensus", "seqs")

# df2: number of representative sequences
fs2_all <- list.files(
  path = "./data/simulate",
  pattern = "*_lines.txt", full.names = TRUE, recursive = TRUE)
# not contain reffasta sifastq
idx <- !grepl(pattern = '.*/(?:reffasta|sifastq)_lines.txt', fs2_all, perl = TRUE) #nolint
fs2 <- fs2_all[idx]

dt2 <- rbindlist(sapply(fs2, fread, simplify = FALSE), idcol = "file", use.names = FALSE) #nolint
dt2$benchmark <- gsub("^.*simulate/(even10|skew10)/RepAlignRef.*", "\\1", dt2$file) #nolint
dt2$bin <- gsub("^.*RepAlignRef/(bin|nobin)/.*", "\\1", dt2$file)
dt2$seqs <- "all"
#dt2$seqs <- gsub("^.*RepAlignRef([a-z]+)_(all|i099c050).*", "\\2", dt2$file)
dt2$id <- as.numeric(gsub("^.*/si(8090|90100|9095|95100|9597|97100|9799|9798|98100|9899|99100).*", "\\1", dt2$V2)) #nolint
dt2$depth <- as.numeric(
  gsub("^.*/si(8090|90100|9095|95100|9597|97100|9799|9798|98100|9899|99100)([0-9]+).*", "\\2", dt2$V2)) #nolint
dt2$cluster <- gsub("^.*split/(.*Con.*)/si.*/si.*", "\\1", dt2$V2)
dt2 <- dt2[, !c("file", "V2")]
df2 <- as.data.frame(dt2)
# fasta: two lines per read
df2$V1 <- df2$V1 / 2
colnames(df2) <- c("nseqs", "benchmark", "bin", "seqs", "id", "depth", "consensus")

# df3: number of actual simulated reads, either bin or nobin (same)
fs3_all <- list.files(
  path = "./data/simulate",
  pattern = "*sifastq_lines.txt", full.names = TRUE, recursive = TRUE)
fs3 <- grep(pattern = '.*nobin.*', fs3_all, value = TRUE)
dt3 <- rbindlist(sapply(fs3, function(x) fread(x, header=FALSE), simplify = FALSE), idcol = "file", use.names = FALSE) #nolint
dt3$benchmark <- gsub("^.*simulate/(even10|skew10)/RepAlignRef.*", "\\1", dt3$file) #nolint
dt3$id <- as.numeric(gsub("^.*/si(8090|90100|9095|95100|9597|97100|9799|9798|98100|9899|99100).*", "\\1", dt3$V2)) #nolint
dt3$reads_arg <- as.numeric(
  gsub("^.*/si(8090|90100|9095|95100|9597|97100|9799|9798|98100|9899|99100)([0-9]+).*", "\\2", dt3$V2)) #nolint
dt3 <- dt3[, !c("file","V2")]
df3 <- as.data.frame(dt3)
# fastq: four lines per read
df3$V1 <- df3$V1 / 4
colnames(df3) <- c("reads", "benchmark", "id", "depth")
#left_join
df23 <- df2 %>%
  left_join(df3, by = c("benchmark", "id", "depth")) 
```

```{r, visual-dt2, eval = FALSE}
df23$depth2 <- df23$reads / 10
library(ggplot2)
library(ggprism)
library(forcats)
p1 <- df23 %>%
  filter(id %in% c(9095,9597,9798,9899,99100)) %>% 
  ggplot( 
    aes(
      x = depth,
      y = nseqs, 
      color = factor(
        id, 
        levels = c(9095,9597,9798,9899,99100),
        labels = c("5~10%", "3~5%", "2~3%", "1~2%", "0~1%") #nolint
        ))) +
  geom_point() +
  geom_line(aes(
    linetype = factor(
      bin, 
      levels = c("bin", "nobin"),
      labels = c("Yes", "No")
    ))) +
  labs(
    x = "Sequencing depth on log2 scale",
    y = "# of polished sequences",
    color = "% of Divergence",
    linetype = "K-mer binning\non all reads"
   ) +
  # add line y = 10, 10 refs
  geom_hline(yintercept = 10, linetype = "dashed") +
  scale_color_manual(values = brewer.pal(8, "Spectral")[c(1,3,4,7,8)]) +
  scale_y_continuous(breaks = c(0, 10, 20, 50, 100, 150)) +
  scale_x_continuous(
    trans = scales::log2_trans(),
    breaks = c(10,20,40,60,80,100,200,400,600,800,1000),
    ) +
  facet_grid(
    benchmark ~ factor(
      consensus,
      levels = c("kmerCon", "clustCon", "isONclustCon", "isONclustCon2","isONcorCon")), #nolint
    scales = "free_y") +
  theme_prism() +
  theme(
    legend.title = element_text(),
    axis.text.x.bottom = element_text(angle = 90, vjust = 0.5, hjust = 1))
```
```{r, visual-dt1}
df$asm <- factor(df$asm, levels = c("asm5", "asm10", "asm20"))
# grouped stats per benchmark
# !!!strand drep rev complement: representative sequences
df123 <- df %>%
  group_by(benchmark, bin, id, depth, asm, seqs, consensus) %>%
  # mapq = 60: unique mapping
  # https://github.com/lh3/minimap2/issues/447
  # http://www.acgt.me/blog/2014/12/16/understanding-mapq-scores-in-sam-files-does-37-42#:~:text=MAPQ%3A%20MAPping%20Quality.,mapping%20quality%20is%20not%20available.
  #filter(mapq >= 60) %>%
  summarise(
    tn = n_distinct(tseq),
    qn = n_distinct(qseq),
  ) %>%
  # join df2
  left_join(df23, by = c("benchmark", "bin","id", "depth", "seqs", "consensus")) %>%
  mutate(
    qper = qn / nseqs * 100,
    tper = tn / 10 * 100,
  )

p2 <- df123 %>%
  filter(id %in% c(9095,9597,9798,9899,99100)) %>%
  ggplot(
  aes(
    x = depth, 
    y = tn,
    color = factor(
      id, 
      levels = c(9095,9597,9798,9899,99100),
      labels = c("5~10%", "3~5%", "2~3%", "1~2%", "0~1%") #nolint
      ))) + 
  geom_point() +
  geom_line(aes(
    linetype = factor(
      bin, 
      levels = c("bin", "nobin"),
      labels = c("Yes", "No")
    ))) +
  labs(
    x = "Sequencing depth on log2 scale",
    y = "# of recovered reference",
    color = "% of Divergence",
    linetype = "K-mer binning\non all reads"
   ) +
  # add line y = 10, 10 refs
  geom_hline(yintercept = 10, linetype = "dashed") +
  scale_color_manual(values = brewer.pal(8, "Spectral")[c(1,3,4,7,8)]) +
  scale_x_continuous(
    trans = scales::log2_trans(),
    breaks = c(10,20,40,60,80,100,200,400,600,800,1000),
    ) +
  facet_grid(asm + benchmark ~
      factor(
        consensus,
        levels = c("kmerCon", "clustCon", "isONclustCon", "isONclustCon2", "isONclustCon3", "isONcorCon"), #nolint
        )
      ) +
  theme_prism() +
  theme(
    legend.title = element_text(),
    axis.text.x.bottom = element_text(
      angle = 90, vjust = 0.5, hjust = 1, size = 9
      )
    )

p2_asm5 <- df123 %>%
  filter(id %in% c(9095,9597,9798,9899,99100), asm == "asm5") %>%
  ggplot(
  aes(
    x = depth, 
    y = tn,
    color = factor(
      id, 
      levels = c(9095,9597,9798,9899,99100),
      labels = c("5~10%", "3~5%", "2~3%", "1~2%", "0~1%") #nolint
      ))) + 
  geom_point() +
  geom_line(aes(
    linetype = factor(
      bin, 
      levels = c("bin", "nobin"),
      labels = c("Yes", "No")
    ))) +
  labs(
    x = "Sequencing depth on log2 scale",
    y = "# of recovered reference",
    color = "% of Divergence",
    linetype = "K-mer binning\non all reads"
   ) +
  # add line y = 10, 10 refs
  geom_hline(yintercept = 10, linetype = "dashed") +
  scale_color_manual(values = brewer.pal(8, "Spectral")[c(1,3,4,7,8)]) +
  scale_x_continuous(
    trans = scales::log2_trans(),
    breaks = c(10,20,40,60,80,100,200,400,600,800,1000),
    ) +
  facet_grid(asm + benchmark ~
      factor(
        consensus,
        levels = c("kmerCon", "clustCon", "isONclustCon", "isONclustCon2", "isONclustCon3", "isONcorCon"), #nolint
        )
      ) +
  theme_prism() +
  theme(
    legend.title = element_text(),
    axis.text.x.bottom = element_text(
      angle = 90, vjust = 0.5, hjust = 1, size = 9
      )
    )

p3 <- df123 %>%
  filter(id %in% c(9095,9597,9798,9899,99100)) %>%
  ggplot(
  aes(
    x = depth, 
    y = qper,
    color = factor(
      id, 
      levels = c(9095,9597,9798,9899,99100),
      labels = c("5~10%", "3~5%", "2~3%", "1~2%", "0~1%") #nolint
      ))) + 
  geom_point() +
  geom_line(aes(
    linetype = factor(
      bin, 
      levels = c("bin", "nobin"),
      labels = c("Yes", "No")
    ))) +
  labs(
    x = "Sequencing depth on log2 scale",
    y = "% of aligned sequences",
    color = "% of Divergence",
    linetype = "K-mer binning\non all reads"
   ) +
  scale_color_brewer(palette = "Spectral") +
  scale_x_continuous(
    trans = scales::log2_trans(),
    breaks = c(10,20,40,60,80,100,200,400,600,800,1000),
    ) +
  facet_grid(asm + benchmark ~
      factor(
        consensus,
        levels = c("kmerCon", "clustCon", "isONclustCon", "isONclustCon2", "isONcorCon"), #nobin
        )
        ) +
  theme_prism() +
  theme(
    legend.title = element_text(),
    axis.text.x.bottom = element_text(
      angle = 90, vjust = 0.5, hjust = 1, size = 9
      )
    )

# alignment accuracy
# % of matches
df$qcov <- df$matches / df$qlen * 100
df$tcov <- df$matches / df$tlen * 100
# % of matches, blast-like identity
df$alnid <- df$matches / (df$alnlen) * 100

# blast-like identity
p4_alnid <- df %>%
  filter(id %in% c(9095,9597,9798,9899,99100)) %>%
  filter(asm == "asm10") %>%
  ggplot(aes(
    x = factor(
      consensus, 
      levels = c("kmerCon", "clustCon", "isONclustCon", "isONclustCon2", "isONcorCon"), #nolint
    ), 
    y = alnid, 
    color = mapq
    )) +
  geom_jitter(aes(
    shape = factor(
      bin, 
      levels = c("bin", "nobin"),
      labels = c("Yes", "No")
    ))) +
  labs(
    x = "",
    y = "% of BLAST-like alignment identity",
    color = "MAPQ",
    shape = "K-mer binning\non all reads",
   ) +
  scale_color_distiller(palette = "Spectral") +
  facet_grid(
    factor(
      id, 
      levels = c(9095,9597,9798,9899,99100),
      labels = c("5~10%", "3~5%", "2~3%", "1~2%", "0~1%") #nolint
      ) + benchmark ~ depth) +
  theme_prism() +
  theme(
    legend.title = element_text(),
    axis.text.x.bottom = element_text(angle = 90, vjust = 0.5, hjust = 1))
 
# qcov
p4_qcov <- df %>%
  filter(id %in% c(9095,9597,9798,9899,99100)) %>%
  filter(asm == "asm10") %>%
  ggplot(aes(
    x = factor(
      consensus, 
      levels = c("kmerCon", "clustCon", "isONclustCon", "isONclustCon2", "isONcorCon"), #nolint
    ), 
    y = qcov, 
    color = mapq
    )) +
  geom_jitter(aes(
    shape = factor(
      bin, 
      levels = c("bin", "nobin"),
      labels = c("Yes", "No")
    ))) +
  labs(
    x = "",
    y = "% of matches in query",
    color = "MAPQ",
    shape = "K-mer binning\non all reads",
   ) +
  scale_color_distiller(palette = "Spectral") +
  facet_grid(
    factor(
      id, 
      levels = c(9095,9597,9798,9899,99100),
      labels = c("5~10%", "3~5%", "2~3%", "1~2%", "0~1%") #nolint
      ) + benchmark ~ depth) +
  theme_prism() +
  theme(
    legend.title = element_text(),
    axis.text.x.bottom = element_text(angle = 90, vjust = 0.5, hjust = 1))
 
# tcov
p4_tcov <- df %>%
  filter(id %in% c(9095,9597,9798,9899,99100)) %>%
  filter(asm == "asm10") %>%
  ggplot(aes(
    x = factor(
      consensus, 
      levels = c("kmerCon", "clustCon", "isONclustCon", "isONclustCon2", "isONcorCon"), #nolint
    ), 
    y = tcov, 
    color = mapq
    )) +
  geom_jitter(aes(
    shape = factor(
      bin, 
      levels = c("bin", "nobin"),
      labels = c("Yes", "No")
    ))) +
  labs(
    x = "",
    y = "% of matches in target",
    color = "MAPQ",
    shape = "K-mer binning\non all reads",
   ) +
  scale_color_distiller(palette = "Spectral") +
  facet_grid(
    factor(
      id, 
      levels = c(9095,9597,9798,9899,99100),
      labels = c("5~10%", "3~5%", "2~3%", "1~2%", "0~1%") #nolint
      ) + benchmark ~ depth) +
  theme_prism() +
  theme(
    legend.title = element_text(),
    axis.text.x.bottom = element_text(angle = 90, vjust = 0.5, hjust = 1))

# p5: qaln qcov qtaln taln tcov ttaln in one, id = 99%
p5 <- df %>%
  filter(asm == "asm10", id == 9899) %>%
  select(qseq, mapq, benchmark, bin, seqs, depth, alnid,
  qcov, tcov, consensus) %>%
  gather(key = "stats", value = "value",
   -qseq, -mapq, -benchmark, -bin, -seqs, -depth, -consensus) %>%
  ggplot(aes(
    x = factor(
      consensus, 
      levels = c("kmerCon", "clustCon", "isONclustCon", "isONclustCon2", "isONcorCon"), #nolint
      ),
    y = value,
    color = mapq)) +
  geom_jitter(aes(
    shape = factor(
      bin, 
      levels = c("bin", "nobin"),
      labels = c("Yes", "No")
    ))) +
  labs(
    x = "",
    y = "Alignment statistics [Divergency  1~2%]",
    color = "MAPQ",
    shape = "K-mer binning\non all reads",
   ) +
  scale_color_distiller(palette = "Spectral") +
  facet_grid(stats + benchmark ~ depth) +
  theme_prism() +
  theme(
    legend.title = element_text(),
    axis.text.x.bottom = element_text(angle = 90, vjust = 0.5, hjust = 1))
```

```{r, pngs}
dir.create("figure/draft/insilico", showWarnings = FALSE, recursive = TRUE)
library(patchwork)
p1 <- p1_cls / p2_asm5 +
 plot_annotation(tag_levels = "a") +
 plot_layout(guides = "collect", heights = c(3,1))

ps <- list(
  p1, p1_cls, p2, p3, p4_alnid, p4_qcov, p4_tcov
  )
pnames <- c(
  "p1", "p1_cls", "p2_refcov", "p3_tseqsnum",
  "p4_alnid", "p4_qcov", "p4_tcov"
  )
ggsave2 <- function(x, y, width = 16, height = 12) {
  ggsave(
    paste0("figure/draft/insilico/", x, ".png"),
    y,
    width = width,
    height = height,
    )
}
mapply(ggsave2, pnames, ps)
ps2 <- list(p1_loss,p1_lossid, p0_cls)
pnames2 <- c("p1_loss", "p1_lossid", "p0_cls")
mapply(ggsave2, pnames2, ps2, 16, 8)
ggsave2("p5_stats9899", p5, 16, 8)
```
